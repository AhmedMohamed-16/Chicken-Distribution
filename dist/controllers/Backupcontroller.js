"use strict";function _regenerator(){function b(a,b,f,g){var h=b&&b.prototype instanceof d?b:d,c=Object.create(h.prototype);return _regeneratorDefine2(c,"_invoke",function(a,b,g){function h(a,b){for(q=a,s=b,e=0;!w&&t&&!c&&e<v.length;e++){var c,f=v[e],g=p.p,h=f[2];3<a?(c=h===b)&&(s=f[(q=f[4])?5:(q=3,3)],f[4]=f[5]=j):f[0]<=g&&((c=2>a&&g<f[1])?(q=0,p.v=b,p.n=f[1]):g<h&&(c=3>a||f[0]>b||b>h)&&(f[4]=a,f[5]=b,p.n=h,q=0))}if(c||1<a)return m;throw w=!0,b}var k,q,s,t=0,v=g||[],w=!1,p={p:0,n:0,v:j,a:h,f:h.bind(j,4),d:function c(a,b){return k=a,q=0,s=j,p.n=b,m}};return function(c,d,f){if(1<t)throw TypeError("Generator is already running");for(w&&1===d&&h(d,f),q=d,s=f;(e=2>q?j:s)||!w;){k||(q?3>q?(1<q&&(p.n=-1),h(q,s)):p.n=s:p.v=s);try{if(t=2,k){if(q||(c="next"),e=k[c]){if(!(e=e.call(k,s)))throw TypeError("iterator result is not an object");if(!e.done)return e;s=e.value,2>q&&(q=0)}else 1===q&&(e=k["return"])&&e.call(k),2>q&&(s=TypeError("The iterator does not provide a '"+c+"' method"),q=1);k=j}else if((e=(w=0>p.n)?s:a.call(b,p))!==m)break}catch(a){k=j,q=1,s=a}finally{t=1}}return{value:e,done:w}}}(a,f,g),!0),c}function d(){}function g(){}function h(){}function i(a){return Object.setPrototypeOf?Object.setPrototypeOf(a,h):(a.__proto__=h,_regeneratorDefine2(a,l,"GeneratorFunction")),a.prototype=Object.create(c),a}/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var j,e,f="function"==typeof Symbol?Symbol:{},k=f.iterator||"@@iterator",l=f.toStringTag||"@@toStringTag",m={};e=Object.getPrototypeOf;var a=[][k]?e(e([][k]())):(_regeneratorDefine2(e={},k,function(){return this}),e),c=h.prototype=d.prototype=Object.create(a);return g.prototype=h,_regeneratorDefine2(c,"constructor",h),_regeneratorDefine2(h,"constructor",g),g.displayName="GeneratorFunction",_regeneratorDefine2(h,l,"GeneratorFunction"),_regeneratorDefine2(c),_regeneratorDefine2(c,l,"Generator"),_regeneratorDefine2(c,k,function(){return this}),_regeneratorDefine2(c,"toString",function(){return"[object Generator]"}),(_regenerator=function a(){return{w:b,m:i}})()}function _regeneratorDefine2(a,b,c,d){var f=Object.defineProperty;try{f({},"",{})}catch(a){f=0}_regeneratorDefine2=function e(a,b,c,d){function g(b,c){_regeneratorDefine2(a,b,function(a){return this._invoke(b,c,a)})}b?f?f(a,b,{value:c,enumerable:!d,configurable:!d,writable:!d}):a[b]=c:(g("next",0),g("throw",1),g("return",2))},_regeneratorDefine2(a,b,c,d)}function asyncGeneratorStep(b,d,f,e,g,h,a){try{var c=b[h](a),i=c.value}catch(a){return void f(a)}c.done?d(i):Promise.resolve(i).then(e,g)}function _asyncToGenerator(b){return function(){var c=this,d=arguments;return new Promise(function(e,f){function g(a){asyncGeneratorStep(i,e,f,g,h,"next",a)}function h(a){asyncGeneratorStep(i,e,f,g,h,"throw",a)}var i=b.apply(c,d);g(void 0)})}}/**
 * Backup Controller
 * Handles HTTP requests for backup operations
 */var path=require("path"),fs=require("fs").promises,_require=require("../services/Backupservice"),createBackup=_require.createBackup,listBackups=_require.listBackups,BACKUP_DIR=_require.BACKUP_DIR,_require2=require("../services/Restoreservice "),restoreBackup=_require2.restoreBackup,validateBackupFile=_require2.validateBackupFile,createBackupController=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/_regenerator().m(function c(a,b){var d,e,f,g;return _regenerator().w(function(c){for(;1;)switch(c.p=c.n){case 0:return c.p=0,e=(null===(d=a.user)||void 0===d?void 0:d.id)||1,console.log("Backup requested by user ".concat(e)),c.n=1,createBackup(e);case 1:f=c.v,b.status(200).json({success:!0,message:"Backup created successfully",data:{backupId:f.backupId,filename:f.filename,fileSize:f.fileSize,fileSizeMB:(f.fileSize/1024/1024).toFixed(2),tableCount:f.tableCount,tables:f.tables,duration:f.duration,downloadUrl:"/api/backup/download/".concat(f.filename)}}),c.n=3;break;case 2:c.p=2,g=c.v,console.error("Backup controller error:",g),b.status(500).json({success:!1,message:"Failed to create backup",error:g.message});case 3:return c.a(2)}},c,null,[[0,2]])}));return function d(b,c){return a.apply(this,arguments)}}(),downloadBackupController=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/_regenerator().m(function c(a,b){var d,e,f,g,h,i;return _regenerator().w(function(c){for(;1;)switch(c.p=c.n){case 0:if(c.p=0,d=a.params.filename,!(d.includes("..")||d.includes("/")||d.includes("\\"))){c.n=1;break}return c.a(2,b.status(400).json({success:!1,message:"Invalid filename"}));case 1:return e=path.join(BACKUP_DIR,d),c.p=2,c.n=3,fs.access(e);case 3:c.n=5;break;case 4:return c.p=4,h=c.v,c.a(2,b.status(404).json({success:!1,message:"Backup file not found"}));case 5:return c.n=6,fs.stat(e);case 6:f=c.v,b.setHeader("Content-Type","application/zip"),b.setHeader("Content-Disposition","attachment; filename=\"".concat(d,"\"")),b.setHeader("Content-Length",f.size),g=require("fs").createReadStream(e),g.pipe(b),g.on("error",function(a){console.error("File stream error:",a),b.headersSent||b.status(500).json({success:!1,message:"Error streaming file"})}),console.log("Backup file downloaded: ".concat(d)),c.n=8;break;case 7:c.p=7,i=c.v,console.error("Download controller error:",i),b.status(500).json({success:!1,message:"Failed to download backup",error:i.message});case 8:return c.a(2)}},c,null,[[2,4],[0,7]])}));return function d(b,c){return a.apply(this,arguments)}}(),restoreBackupController=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/_regenerator().m(function c(a,b){var d,e,f,g,h,i,j;return _regenerator().w(function(c){for(;1;)switch(c.p=c.n){case 0:if(d=null,c.p=1,a.file){c.n=2;break}return c.a(2,b.status(400).json({success:!1,message:"No backup file uploaded"}));case 2:if(d=a.file.path,e=a.body.strategy||"replace",["replace","append"].includes(e)){c.n=3;break}return c.a(2,b.status(400).json({success:!1,message:"Invalid restore strategy. Use \"replace\" or \"append\""}));case 3:return console.log("Restore requested with strategy: ".concat(e)),console.log("File: ".concat(a.file.originalname," (").concat(a.file.size," bytes)")),c.n=4,validateBackupFile(d);case 4:if(f=c.v,f.valid){c.n=6;break}return c.n=5,fs.unlink(d);case 5:return c.a(2,b.status(400).json({success:!1,message:"Invalid backup file",error:f.error}));case 6:return c.n=7,restoreBackup(d,e);case 7:return g=c.v,c.p=8,c.n=9,fs.unlink(d);case 9:c.n=11;break;case 10:c.p=10,h=c.v,console.warn("Could not delete uploaded file:",h.message);case 11:b.status(200).json({success:!0,message:"Database restored successfully",data:{strategy:g.strategy,duration:g.duration,tablesProcessed:g.tablesProcessed,totalInserted:g.totalInserted,totalUpdated:g.totalUpdated,totalErrors:g.totalErrors,metadata:g.metadata}}),c.n=17;break;case 12:if(c.p=12,i=c.v,console.error("Restore controller error:",i),!d){c.n=16;break}return c.p=13,c.n=14,fs.unlink(d);case 14:c.n=16;break;case 15:c.p=15,j=c.v,console.warn("Could not delete uploaded file:",j.message);case 16:b.status(500).json({success:!1,message:"Failed to restore backup",error:i.message});case 17:return c.a(2)}},c,null,[[13,15],[8,10],[1,12]])}));return function d(b,c){return a.apply(this,arguments)}}(),listBackupsController=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/_regenerator().m(function c(a,b){var d,e;return _regenerator().w(function(a){for(;1;)switch(a.p=a.n){case 0:return a.p=0,a.n=1,listBackups();case 1:d=a.v,b.status(200).json({success:!0,count:d.length,data:d.map(function(a){return{id:a.id,filename:a.backup_name,date:a.backup_date,fileSize:a.file_size,fileSizeMB:a.file_size?(a.file_size/1024/1024).toFixed(2):null,status:a.status,downloadUrl:"/api/backup/download/".concat(a.backup_name)}})}),a.n=3;break;case 2:a.p=2,e=a.v,console.error("List backups controller error:",e),b.status(500).json({success:!1,message:"Failed to list backups",error:e.message});case 3:return a.a(2)}},c,null,[[0,2]])}));return function d(b,c){return a.apply(this,arguments)}}();/**
 * Create a new backup
 * POST /api/backup
 *//**
 * Download a backup file
 * GET /api/backup/download/:filename
 *//**
 * Restore database from uploaded backup file
 * POST /api/backup/restore
 *//**
 * List all available backups
 * GET /api/backup/list
 */module.exports={createBackupController:createBackupController,downloadBackupController:downloadBackupController,restoreBackupController:restoreBackupController,listBackupsController:listBackupsController};