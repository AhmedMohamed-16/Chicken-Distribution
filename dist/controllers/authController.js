"use strict";function _regenerator(){function b(a,b,f,g){var h=b&&b.prototype instanceof d?b:d,c=Object.create(h.prototype);return _regeneratorDefine2(c,"_invoke",function(a,b,g){function h(a,b){for(q=a,s=b,e=0;!w&&t&&!c&&e<v.length;e++){var c,f=v[e],g=p.p,h=f[2];3<a?(c=h===b)&&(s=f[(q=f[4])?5:(q=3,3)],f[4]=f[5]=j):f[0]<=g&&((c=2>a&&g<f[1])?(q=0,p.v=b,p.n=f[1]):g<h&&(c=3>a||f[0]>b||b>h)&&(f[4]=a,f[5]=b,p.n=h,q=0))}if(c||1<a)return m;throw w=!0,b}var k,q,s,t=0,v=g||[],w=!1,p={p:0,n:0,v:j,a:h,f:h.bind(j,4),d:function c(a,b){return k=a,q=0,s=j,p.n=b,m}};return function(c,d,f){if(1<t)throw TypeError("Generator is already running");for(w&&1===d&&h(d,f),q=d,s=f;(e=2>q?j:s)||!w;){k||(q?3>q?(1<q&&(p.n=-1),h(q,s)):p.n=s:p.v=s);try{if(t=2,k){if(q||(c="next"),e=k[c]){if(!(e=e.call(k,s)))throw TypeError("iterator result is not an object");if(!e.done)return e;s=e.value,2>q&&(q=0)}else 1===q&&(e=k["return"])&&e.call(k),2>q&&(s=TypeError("The iterator does not provide a '"+c+"' method"),q=1);k=j}else if((e=(w=0>p.n)?s:a.call(b,p))!==m)break}catch(a){k=j,q=1,s=a}finally{t=1}}return{value:e,done:w}}}(a,f,g),!0),c}function d(){}function g(){}function h(){}function i(a){return Object.setPrototypeOf?Object.setPrototypeOf(a,h):(a.__proto__=h,_regeneratorDefine2(a,l,"GeneratorFunction")),a.prototype=Object.create(c),a}/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var j,e,f="function"==typeof Symbol?Symbol:{},k=f.iterator||"@@iterator",l=f.toStringTag||"@@toStringTag",m={};e=Object.getPrototypeOf;var a=[][k]?e(e([][k]())):(_regeneratorDefine2(e={},k,function(){return this}),e),c=h.prototype=d.prototype=Object.create(a);return g.prototype=h,_regeneratorDefine2(c,"constructor",h),_regeneratorDefine2(h,"constructor",g),g.displayName="GeneratorFunction",_regeneratorDefine2(h,l,"GeneratorFunction"),_regeneratorDefine2(c),_regeneratorDefine2(c,l,"Generator"),_regeneratorDefine2(c,k,function(){return this}),_regeneratorDefine2(c,"toString",function(){return"[object Generator]"}),(_regenerator=function a(){return{w:b,m:i}})()}function _regeneratorDefine2(a,b,c,d){var f=Object.defineProperty;try{f({},"",{})}catch(a){f=0}_regeneratorDefine2=function e(a,b,c,d){function g(b,c){_regeneratorDefine2(a,b,function(a){return this._invoke(b,c,a)})}b?f?f(a,b,{value:c,enumerable:!d,configurable:!d,writable:!d}):a[b]=c:(g("next",0),g("throw",1),g("return",2))},_regeneratorDefine2(a,b,c,d)}function asyncGeneratorStep(b,d,f,e,g,h,a){try{var c=b[h](a),i=c.value}catch(a){return void f(a)}c.done?d(i):Promise.resolve(i).then(e,g)}function _asyncToGenerator(b){return function(){var c=this,d=arguments;return new Promise(function(e,f){function g(a){asyncGeneratorStep(i,e,f,g,h,"next",a)}function h(a){asyncGeneratorStep(i,e,f,g,h,"throw",a)}var i=b.apply(c,d);g(void 0)})}}// =========================
// File: authController.js (UPDATED)
// Authentication and user self-service
// =========================
var jwt=require("jsonwebtoken"),_require=require("../models"),User=_require.User,Permission=_require.Permission,AppError=require("../utils/app-error.utility");/**
 * User login
 * @route POST /api/auth/login
 * @access Public
 *//**
 * Get current user profile with permissions
 * @route GET /api/auth/profile
 * @access Authenticated users
 *//**
 * Update own profile (limited fields)
 * @route PUT /api/auth/profile
 * @access Authenticated users
 *//**
 * Get current user's permissions
 * @route GET /api/auth/permissions
 * @access Authenticated users
 */exports.login=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/_regenerator().m(function d(a,b,c){var e,f,g,h,i,j,k,l;return _regenerator().w(function(d){for(;1;)switch(d.p=d.n){case 0:return d.p=0,e=a.body,f=e.username,g=e.password,f&&g||c(new AppError("\u0627\u0633\u0645 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645 \u0648\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0645\u0637\u0644\u0648\u0628\u0627\u0646",400)),d.n=1,User.findOne({where:{username:f}});case 1:return h=d.v,h||c(new AppError("\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",401)),h.is_active||c(new AppError("\u0627\u0644\u062D\u0633\u0627\u0628 \u063A\u064A\u0631 \u0646\u0634\u0637. \u064A\u0631\u062C\u0649 \u0627\u0644\u0627\u062A\u0635\u0627\u0644 \u0628\u0627\u0644\u0645\u0633\u0624\u0648\u0644..",403)),d.n=2,h.checkPassword(g);case 2:return i=d.v,i||c(new AppError("\u0628\u064A\u0627\u0646\u0627\u062A \u063A\u064A\u0631 \u0635\u0627\u0644\u062D\u0629",401)),d.n=3,h.getPermissions();case 3:j=d.v,console.log(),k=jwt.sign({id:h.id,username:h.username},process.env.JWT_SECRET,{expiresIn:process.env.JWT_EXPIRES_IN||"24h"}),console.log("permissions",j),b.json({success:!0,message:"\u062A\u0645 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644 \u0628\u0646\u062C\u0627\u062D.",data:{token:k,user:{id:h.id,username:h.username,full_name:h.full_name,email:h.email,phone:h.phone,is_active:h.is_active,permissions:j.map(function(a){return{key:a.key,name:a.name,category:a.category}})}}}),d.n=5;break;case 4:d.p=4,l=d.v,c(new AppError("\u062D\u062F\u062B \u062E\u0637\u0623 \u0623\u062B\u0646\u0627\u0621 \u062A\u0633\u062C\u064A\u0644 \u0627\u0644\u062F\u062E\u0648\u0644"));case 5:return d.a(2)}},d,null,[[0,4]])}));return function(b,c,d){return a.apply(this,arguments)}}(),exports.getProfile=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/_regenerator().m(function d(a,b,c){var e,f;return _regenerator().w(function(d){for(;1;)switch(d.p=d.n){case 0:return d.p=0,d.n=1,User.findByPk(a.user.id,{attributes:{exclude:["password_hash"]},include:[{model:Permission,as:"permissions",attributes:["id","key","name","description","category"]}]});case 1:e=d.v,e||c(new AppError("\u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F ",404)),b.json({success:!0,data:e}),d.n=3;break;case 2:d.p=2,f=d.v,c(new AppError("\u062E\u0637\u0623 \u0627\u062B\u0646\u0627\u0621 \u0627\u0631\u062C\u0627\u0639 \u0627\u0644\u0645\u0644\u0641 \u0627\u0644\u0634\u062E\u0635\u064A ",404));case 3:return d.a(2)}},d,null,[[0,2]])}));return function(b,c,d){return a.apply(this,arguments)}}(),exports.updateProfile=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/_regenerator().m(function d(a,b,c){var e,f,g,h,i,j,k,l,m,n,o,p;return _regenerator().w(function(d){for(;1;)switch(d.p=d.n){case 0:return d.p=0,e=a.body,f=e.full_name,g=e.email,h=e.phone,i=e.current_password,j=e.new_password,d.n=1,User.findByPk(a.user.id);case 1:if(k=d.v,k||c(new AppError("\u0644\u0645 \u064A\u062A\u0645 \u0627\u0644\u0639\u062B\u0648\u0631 \u0639\u0644\u0649 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645",404)),!j){d.n=3;break}return i||c(new AppError("\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0627\u0644\u062D\u0627\u0644\u064A\u0629 \u0645\u0637\u0644\u0648\u0628\u0629 \u0644\u062A\u0639\u064A\u064A\u0646 \u0643\u0644\u0645\u0629 \u0645\u0631\u0648\u0631 \u062C\u062F\u064A\u062F\u0629",404)),d.n=2,k.checkPassword(i);case 2:l=d.v,l||c(new AppError("\u0643\u0644\u0645\u0629 \u0627\u0644\u0645\u0631\u0648\u0631 \u0627\u0644\u062D\u0627\u0644\u064A\u0629 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629",400));case 3:if(!(g&&g!==k.email)){d.n=5;break}return d.n=4,User.findOne({where:{email:g}});case 4:m=d.v,m&&c(new AppError("\u0627\u0644\u0628\u0631\u064A\u062F \u0627\u0644\u0625\u0644\u0643\u062A\u0631\u0648\u0646\u064A \u0642\u064A\u062F \u0627\u0644\u0627\u0633\u062A\u062E\u062F\u0627\u0645 \u0628\u0627\u0644\u0641\u0639\u0644",404));case 5:return n={},void 0!==f&&(n.full_name=f),void 0!==g&&(n.email=g),void 0!==h&&(n.phone=h),j&&(n.password_hash=j),d.n=6,k.update(n);case 6:return d.n=7,User.findByPk(k.id,{attributes:{exclude:["password_hash"]}});case 7:o=d.v,b.json({success:!0,message:"\u062A\u0645 \u062A\u0639\u062F\u064A\u0644 \u0627\u0644\u062D\u0633\u0627\u0628 \u0628\u0646\u062C\u0627\u062D",data:o}),d.n=9;break;case 8:d.p=8,p=d.v,c(new AppError("\u062D\u062F\u062B \u062E\u0637\u0623 \u0623\u062B\u0646\u0627\u0621 \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0645\u0644\u0641 \u0627\u0644\u0634\u062E\u0635\u064A"));case 9:return d.a(2)}},d,null,[[0,8]])}));return function(b,c,d){return a.apply(this,arguments)}}(),exports.getMyPermissions=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/_regenerator().m(function d(a,b,c){var e,f,g,h;return _regenerator().w(function(d){for(;1;)switch(d.p=d.n){case 0:return d.p=0,d.n=1,User.findByPk(a.user.id);case 1:return e=d.v,e||c(new AppError("\u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F ",404)),d.n=2,e.getPermissions();case 2:f=d.v,g=f.reduce(function(a,b){var c=b.category;return a[c]||(a[c]=[]),a[c].push({key:b.key,name:b.name,description:b.description}),a},{}),b.json({success:!0,data:{permissions:f.map(function(a){return{id:a.id,key:a.key,name:a.name,description:a.description,category:a.category}}),grouped:g,permission_keys:f.map(function(a){return a.key})}}),d.n=4;break;case 3:d.p=3,h=d.v,c(new AppError("\u062D\u062F\u062B \u062E\u0637\u0623 \u0641\u064A \u062C\u0644\u0628 \u0627\u0644\u0635\u0644\u0627\u062D\u064A\u0627\u062A"));case 4:return d.a(2)}},d,null,[[0,3]])}));return function(b,c,d){return a.apply(this,arguments)}}(),module.exports=exports;