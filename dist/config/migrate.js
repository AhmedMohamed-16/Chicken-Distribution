"use strict";function _regenerator(){function b(a,b,f,g){var h=b&&b.prototype instanceof d?b:d,c=Object.create(h.prototype);return _regeneratorDefine2(c,"_invoke",function(a,b,g){function h(a,b){for(q=a,s=b,e=0;!w&&t&&!c&&e<v.length;e++){var c,f=v[e],g=p.p,h=f[2];3<a?(c=h===b)&&(s=f[(q=f[4])?5:(q=3,3)],f[4]=f[5]=j):f[0]<=g&&((c=2>a&&g<f[1])?(q=0,p.v=b,p.n=f[1]):g<h&&(c=3>a||f[0]>b||b>h)&&(f[4]=a,f[5]=b,p.n=h,q=0))}if(c||1<a)return m;throw w=!0,b}var k,q,s,t=0,v=g||[],w=!1,p={p:0,n:0,v:j,a:h,f:h.bind(j,4),d:function c(a,b){return k=a,q=0,s=j,p.n=b,m}};return function(c,d,f){if(1<t)throw TypeError("Generator is already running");for(w&&1===d&&h(d,f),q=d,s=f;(e=2>q?j:s)||!w;){k||(q?3>q?(1<q&&(p.n=-1),h(q,s)):p.n=s:p.v=s);try{if(t=2,k){if(q||(c="next"),e=k[c]){if(!(e=e.call(k,s)))throw TypeError("iterator result is not an object");if(!e.done)return e;s=e.value,2>q&&(q=0)}else 1===q&&(e=k["return"])&&e.call(k),2>q&&(s=TypeError("The iterator does not provide a '"+c+"' method"),q=1);k=j}else if((e=(w=0>p.n)?s:a.call(b,p))!==m)break}catch(a){k=j,q=1,s=a}finally{t=1}}return{value:e,done:w}}}(a,f,g),!0),c}function d(){}function g(){}function h(){}function i(a){return Object.setPrototypeOf?Object.setPrototypeOf(a,h):(a.__proto__=h,_regeneratorDefine2(a,l,"GeneratorFunction")),a.prototype=Object.create(c),a}/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var j,e,f="function"==typeof Symbol?Symbol:{},k=f.iterator||"@@iterator",l=f.toStringTag||"@@toStringTag",m={};e=Object.getPrototypeOf;var a=[][k]?e(e([][k]())):(_regeneratorDefine2(e={},k,function(){return this}),e),c=h.prototype=d.prototype=Object.create(a);return g.prototype=h,_regeneratorDefine2(c,"constructor",h),_regeneratorDefine2(h,"constructor",g),g.displayName="GeneratorFunction",_regeneratorDefine2(h,l,"GeneratorFunction"),_regeneratorDefine2(c),_regeneratorDefine2(c,l,"Generator"),_regeneratorDefine2(c,k,function(){return this}),_regeneratorDefine2(c,"toString",function(){return"[object Generator]"}),(_regenerator=function a(){return{w:b,m:i}})()}function _regeneratorDefine2(a,b,c,d){var f=Object.defineProperty;try{f({},"",{})}catch(a){f=0}_regeneratorDefine2=function e(a,b,c,d){function g(b,c){_regeneratorDefine2(a,b,function(a){return this._invoke(b,c,a)})}b?f?f(a,b,{value:c,enumerable:!d,configurable:!d,writable:!d}):a[b]=c:(g("next",0),g("throw",1),g("return",2))},_regeneratorDefine2(a,b,c,d)}function asyncGeneratorStep(b,d,f,e,g,h,a){try{var c=b[h](a),i=c.value}catch(a){return void f(a)}c.done?d(i):Promise.resolve(i).then(e,g)}function _asyncToGenerator(b){return function(){var c=this,d=arguments;return new Promise(function(e,f){function g(a){asyncGeneratorStep(i,e,f,g,h,"next",a)}function h(a){asyncGeneratorStep(i,e,f,g,h,"throw",a)}var i=b.apply(c,d);g(void 0)})}}// ========================================
// DATABASE MIGRATION SCRIPT - IMPROVED
// Handles foreign key constraints properly
// ========================================
var _require=require("./config/database"),sequelize=_require.sequelize,testConnection=_require.testConnection,getDatabaseInfo=_require.getDatabaseInfo;require("dotenv").config();var colors={reset:"\x1B[0m",bright:"\x1B[1m",green:"\x1B[32m",red:"\x1B[31m",yellow:"\x1B[33m",blue:"\x1B[36m"};function log(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"reset";console.log("".concat(colors[b]).concat(a).concat(colors.reset))}function migrate(){return _migrate.apply(this,arguments)}// Handle script arguments
function _migrate(){return _migrate=_asyncToGenerator(/*#__PURE__*/_regenerator().m(function a(){var b,c,d,e,f,g,h,i,j,k,l,m,n;return _regenerator().w(function(a){for(;1;)switch(a.p=a.n){case 0:return a.p=0,log("\n"+"=".repeat(60),"bright"),log("  \uD83D\uDC14 CHICKEN DISTRIBUTION SYSTEM - DATABASE MIGRATION","bright"),log("=".repeat(60)+"\n","bright"),log("\uD83D\uDCE1 Step 1: Testing database connection...","blue"),a.n=1,testConnection();case 1:return b=a.v,b||(log("\n\u274C Migration aborted: Could not connect to database\n","red"),process.exit(1)),a.n=2,getDatabaseInfo();case 2:return c=a.v,c&&(log("   PostgreSQL: ".concat(c.pg_version.split(",")[0]),"yellow"),log("   Database: ".concat(c.db_name),"yellow"),log("   User: ".concat(c.user),"yellow")),log("\n\uD83D\uDCE6 Step 2: Loading models...","blue"),d=require("./models"),e=d.syncModels,log("   \u2705 All models and associations loaded","green"),log("\n\uD83D\uDD04 Step 3: Creating/updating database tables...","blue"),log("   Using correct order for foreign key constraints...","yellow"),f=process.argv.includes("--force"),f&&log("   \u26A0\uFE0F  FORCE MODE: Dropping all tables!","red"),g={alter:!f,// Update tables to match models (unless force)
force:f// Drop and recreate if --force flag
},a.n=3,e(g);case 3:return log("\n   \u2705 Database sync completed!","green"),log("\n\uD83D\uDCCA Step 4: Verifying tables...","blue"),a.n=4,sequelize.query("SELECT table_name \n       FROM information_schema.tables \n       WHERE table_schema = 'public' \n       AND table_type = 'BASE TABLE'\n       ORDER BY table_name",{type:sequelize.QueryTypes.SELECT});case 4:return h=a.v,log("   Found ".concat(h.length," tables:"),"yellow"),i=h.filter(function(a){return["users","partners","vehicles","farms","buyers","chicken_types","cost_categories","permissions"].includes(a.table_name)}),j=h.filter(function(a){return["daily_operations","vehicle_operations","farm_transactions","sale_transactions","transport_losses","daily_costs"].includes(a.table_name)}),k=h.filter(function(a){return["profit_distributions","partner_profits","farm_debt_payments","buyer_debt_payments"].includes(a.table_name)}),l=h.filter(function(a){return["vehicle_partners","user_permissions"].includes(a.table_name)}),0<i.length&&(log("\n   \uD83D\uDCCB Master Data Tables:","blue"),i.forEach(function(a){return log("      - ".concat(a.table_name),"yellow")})),0<j.length&&(log("\n   \uD83D\uDD04 Operation Tables:","blue"),j.forEach(function(a){return log("      - ".concat(a.table_name),"yellow")})),0<k.length&&(log("\n   \uD83D\uDCB0 Financial Tables:","blue"),k.forEach(function(a){return log("      - ".concat(a.table_name),"yellow")})),0<l.length&&(log("\n   \uD83D\uDD17 Junction Tables:","blue"),l.forEach(function(a){return log("      - ".concat(a.table_name),"yellow")})),log("\n"+"=".repeat(60),"bright"),log("  \u2705 MIGRATION COMPLETED SUCCESSFULLY!","green"),log("=".repeat(60),"bright"),log("\n\uD83D\uDCDD Next steps:","blue"),log("   1. Run: node seed.js (to add sample data)","yellow"),log("   2. Or start your backend: npm run dev\n","yellow"),a.n=5,sequelize.close();case 5:process.exit(0),a.n=8;break;case 6:return a.p=6,n=a.v,log("\n\u274C Migration failed:","red"),log("   ".concat(n.message,"\n"),"red"),"SequelizeDatabaseError"===n.name&&(log("\uD83D\uDCA1 Database error details:","yellow"),log("   ".concat((null===(m=n.parent)||void 0===m?void 0:m.message)||n.message),"yellow"),n.message.includes("foreign key")&&(log("\n\uD83D\uDCA1 Foreign key error detected!","yellow"),log("   This usually means tables are being created in wrong order.","yellow"),log("   Try running: node migrate.js --force","yellow"),log("   This will drop all tables and recreate them in correct order.\n","yellow"))),n.stack&&process.argv.includes("--verbose")&&(log("\n\uD83D\uDCCB Stack trace:","yellow"),console.error(n.stack)),a.n=7,sequelize.close();case 7:process.exit(1);case 8:return a.a(2)}},a,null,[[0,6]])})),_migrate.apply(this,arguments)}var args=process.argv.slice(2);(args.includes("--help")||args.includes("-h"))&&(log("\n\uD83D\uDC14 Database Migration Tool","bright"),log("\nUsage:","blue"),log("  node migrate.js            Run migration (alter mode - safe)","yellow"),log("  node migrate.js --force    Drop and recreate all tables (DANGER!)","yellow"),log("  node migrate.js --verbose  Show detailed error traces","yellow"),log("  node migrate.js --help     Show this help\n","yellow"),log("\n\u2139\uFE0F  Notes:","blue"),log("  - Alter mode: Updates existing tables without data loss","yellow"),log("  - Force mode: Deletes ALL data and recreates tables","yellow"),log("  - Tables are created in correct order to respect foreign keys\n","yellow"),process.exit(0)),args.includes("--force")?(log("\n\u26A0\uFE0F  WARNING: FORCE MODE ENABLED","red"),log("   This will DELETE ALL DATA and recreate tables!","red"),log("   Press Ctrl+C within 5 seconds to cancel...\n","yellow"),setTimeout(function(){migrate()},5e3)):migrate();